<div data-name="dispen" class="page page-dispen">
  <div class="navbar">
    <div class="navbar-bg"></div>
    <div class="navbar-inner">
      <div class="left">
        <a href="/" class="link">
          <i class="f7-icons">chevron_left</i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title">Pengajuan Surat Dispensasi</div>
    </div>
  </div>

  <style>
    .page-content { padding: 16px; }
    .item-title .required-mark { color: #dc2626; margin-left: 4px; }
    textarea { resize: vertical; min-height: 80px; }
    .file-info-text { color: #666; font-size: 12px; margin-top: 6px; }
  </style>

  <div class="page-content">
    <form id="dispen-form">
      <div class="list no-hairlines-md">
        <ul>
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Nama Kegiatan <span class="required-mark">*</span></div>
              <div class="item-input-wrap"><input id="eventName" name="eventName" type="text" placeholder="Masukkan nama kegiatan" required></div>
            </div>
          </li>

          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Mata Kuliah <span class="required-mark">*</span></div>
              <div class="item-input-wrap"><input id="courseName" name="courseName" type="text" placeholder="Contoh: Algoritma dan Pemrograman" required></div>
            </div>
          </li>

          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Nama Dosen <span class="required-mark">*</span></div>
              <div class="item-input-wrap"><input id="lecturerName" name="lecturerName" type="text" placeholder="Nama dosen" required></div>
            </div>
          </li>

          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Tanggal <span class="required-mark">*</span></div>
              <div class="item-input-wrap"><input id="date" name="date" type="date" required></div>
            </div>
          </li>

          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Catatan (Opsional)</div>
              <div class="item-input-wrap"><textarea id="notes" name="notes" placeholder="Keterangan atau alasan..."></textarea></div>
            </div>
          </li>

          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Unggah Softfile Surat <span class="required-mark">*</span></div>
              <div class="item-input-wrap">
                <input id="letterFile" name="letterFile" type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                <small class="file-info-text">Format: PDF, DOC, DOCX, JPG, PNG (Max 5MB)</small>
                <div id="fileInfo"></div>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <div id="form-error" style="color:#b91c1c; margin-bottom:12px; min-height:18px"></div>
      <div>
        <button type="submit" class="button button-fill button-large">Ajukan Dispensasi</button>
      </div>
    </form>
  </div>

  <script>
    (function(){
      const form = document.getElementById('dispen-form');
      const fileInput = document.getElementById('letterFile');
      const fileInfo = document.getElementById('fileInfo');
      const formError = document.getElementById('form-error');

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file){ fileInfo.textContent = ''; return; }
        const maxSize = 5 * 1024 * 1024;
        const allowed = ['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','image/jpeg','image/png'];
        if(file.size > maxSize){ fileInfo.textContent = '✗ File terlalu besar (Max 5MB)'; fileInfo.style.color='#dc2626'; fileInput.value = ''; return; }
        if(!allowed.includes(file.type)){ fileInfo.textContent = '✗ Format tidak didukung'; fileInfo.style.color='#dc2626'; fileInput.value = ''; return; }
        fileInfo.textContent = '✓ ' + file.name + ' (' + (file.size/1024).toFixed(2) + ' KB)'; fileInfo.style.color = '#16a34a';
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        formError.textContent = '';
        const data = {
          eventName: document.getElementById('eventName').value.trim(),
          courseName: document.getElementById('courseName').value.trim(),
          lecturerName: document.getElementById('lecturerName').value.trim(),
          date: document.getElementById('date').value,
          notes: document.getElementById('notes').value.trim(),
          letterFile: fileInput.files[0]?.name || '',
          status: 'Pending',
          type: 'Dispen'
        };

        if(!data.eventName || !data.courseName || !data.lecturerName || !data.date || !fileInput.files[0]){
          formError.textContent = 'Semua kolom wajib diisi kecuali Catatan.'; return;
        }

        if(typeof app !== 'undefined' && app.mockBookings){
          app.mockBookings.push(data);
        }

        form.reset(); fileInfo.textContent = '';
        if(typeof app !== 'undefined' && app.views && app.views.main && app.views.main.router){
          app.views.main.router.navigate('/');
        } else { window.location.href = '/'; }
        app.dialog.alert('Pengajuan dispensasi berhasil diajukan', 'Sukses');
      });
    })();
  </script>
</div>