<div data-name="peminjaman" class="page page-peminjaman">
  <div class="navbar">
    <div class="navbar-bg"></div>
    <div class="navbar-inner">
      <div class="left">
        <a href="/index/" class="link back">
          <i class="f7-icons">chevron_left</i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title">Tambah Peminjaman</div>
    </div>
  </div>

  <style>
    .page-content { padding: 16px; }
    #add-form-error { color: #b91c1c; font-size: 13px; min-height: 18px; margin-bottom: 12px; }
    
    /* Styling untuk field required */
    .item-title .required-mark {
      color: #dc2626;
      font-weight: bold;
      margin-left: 4px;
    }
    
    /* Styling untuk file info */
    .file-info-text {
      color: #666;
      display: block;
      margin-top: 5px;
      font-size: 12px;
    }
    
    #fileInfo {
      margin-top: 8px;
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Styling untuk textarea */
    textarea {
      resize: vertical;
      min-height: 80px;
    }
  </style>

  <div class="page-content">
    <form id="add-booking-form">
      <div class="list no-hairlines-md">
        <ul>
          <!-- Nama Kegiatan -->
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Nama Kegiatan <span class="required-mark">*</span></div>
              <div class="item-input-wrap"><input id="eventName" name="eventName" type="text" placeholder="Contoh: Rapat Koordinasi, Workshop" title="Nama Kegiatan" required></div>
            </div>
          </li>

          <!-- Jenis Ruangan -->
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Jenis Ruangan <span class="required-mark">*</span></div>
              <div class="item-input-wrap">
                <select id="roomType" name="roomType" title="Jenis Ruangan" required>
                  <option value="">Pilih Jenis Ruangan</option>
                  <option value="Lab. Komputer">Lab. Komputer</option>
                  <option value="Ruang 101">Ruang 101</option>
                  <option value="Ruang 102">Ruang 102</option>
                  <option value="Ruang 103">Ruang 103</option>
                  <option value="Ruang 104">Ruang 104</option>
                  <option value="Ruang 105">Ruang 105</option>
                  <option value="Ruang 106">Ruang 106</option>
                  <option value="Ruang 107">Ruang 107</option>
                  <option value="Ruang 108">Ruang 108</option>
                  <option value="Ruang 109">Ruang 109</option>
                  <option value="Ruang 110">Ruang 110</option>
                  <option value="Ruang 111">Ruang 111</option>
                  <option value="Ruang 112">Ruang 112</option>
                  <option value="GSG">GSG</option>
                </select>
              </div>
            </div>
          </li>

          <!-- Durasi Peminjaman (Berapa Hari) -->
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Durasi Peminjaman (Hari) <span class="required-mark">*</span></div>
              <div class="item-input-wrap">
                <select id="duration" name="duration" title="Durasi Peminjaman" required onchange="updateDurationInfo()">
                  <option value="">Pilih Durasi</option>
                  <option value="1">1 Hari</option>
                  <option value="2">2 Hari</option>
                  <option value="3">3 Hari</option>
                  <option value="5">5 Hari</option>
                  <option value="7">1 Minggu</option>
                  <option value="14">2 Minggu</option>
                  <option value="30">1 Bulan</option>
                </select>
              </div>
            </div>
          </li>

          <!-- Tanggal Peminjaman -->
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Tanggal Peminjaman <span class="required-mark">*</span></div>
              <div class="item-input-wrap">
                <input id="borrowDate" name="borrowDate" type="text" title="Tanggal Peminjaman" placeholder="Pilih dari kalender" readonly>
                <button type="button" class="btn-open-calendar"
                  onclick="app.views.main.router.navigate('/calendar/')">
                  Buka Kalender
                </button>
                <div id="durationInfo"></div>
              </div>
            </div>
          </li>

          <!-- Jam Mulai Acara -->
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Jam Mulai Acara <span class="required-mark">*</span></div>
              <div class="item-input-wrap"><input id="startTime" name="startTime" type="time" title="Jam Mulai Acara" placeholder="HH:MM" required></div>
            </div>
          </li>

          <!-- Jam Selesai Acara -->
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Jam Selesai Acara <span class="required-mark">*</span></div>
              <div class="item-input-wrap"><input id="endTime" name="endTime" type="time" title="Jam Selesai Acara" placeholder="HH:MM" required></div>
            </div>
          </li>

          <!-- Catatan (Opsional) -->
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Catatan (Opsional)</div>
              <div class="item-input-wrap"><textarea id="notes" name="notes" title="Catatan" placeholder="Keterangan atau kebutuhan khusus..."></textarea></div>
            </div>
          </li>

          <!-- Upload Surat -->
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Unggah Softfile Surat <span class="required-mark">*</span></div>
              <div class="item-input-wrap">
                <input id="letterFile" name="letterFile" type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" title="Unggah Softfile Surat" required>
                <small class="file-info-text">Format: PDF, DOC, DOCX, JPG, PNG (Max 5MB)</small>
                <div id="fileInfo"></div>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <div id="add-form-error"></div>

      <div class="block">
        <button type="submit" class="button button-fill">Tambah</button>
      </div>
    </form>
  </div>
</div>

<script src="js/framework7.bundle.min.js"></script>
<script src="js/app.js"></script>
<script>
  const addBookingForm = document.getElementById('add-booking-form');
  const addFormError = document.getElementById('add-form-error');
  const fileInput = document.getElementById('letterFile');
  const fileInfo = document.getElementById('fileInfo');

  // Set default tanggal hari ini
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('borrowDate').value = today;

  // Event listener untuk file upload
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Validasi ukuran file (max 5MB)
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        fileInfo.textContent = '❌ File terlalu besar (Max 5MB)';
        fileInfo.style.color = '#b91c1c';
        fileInput.value = '';
        return;
      }
      fileInfo.textContent = '✓ ' + file.name + ' (' + (file.size / 1024).toFixed(2) + ' KB)';
      fileInfo.style.color = '#16a34a';
    } else {
      fileInfo.textContent = '';
    }
  });

  // Event listener form submit
  addBookingForm.addEventListener('submit', (e) => {
    e.preventDefault();
    addFormError.textContent = '';

    const borrowEl = document.getElementById('borrowDate');
    // Prefer ISO stored on dataset (set by calendar); fallback to displayed value
    const borrowIso = (borrowEl && borrowEl.dataset && borrowEl.dataset.iso) ? borrowEl.dataset.iso.split(',')[0] : borrowEl.value;
    const duration = parseInt(document.getElementById('duration').value);
    const returnDate = new Date(borrowIso);
    returnDate.setDate(returnDate.getDate() + duration);
    const returnDateStr = returnDate.toISOString().split('T')[0];

    const formData = {
      id: app.mockBookings.length > 0 ? Math.max(...app.mockBookings.map(b => b.id)) + 1 : 1,
      eventName: document.getElementById('eventName').value.trim(),
      roomType: document.getElementById('roomType').value,
      borrowDate: new Date(borrowIso),
      duration: duration,
      returnDate: new Date(returnDateStr),
      startTime: document.getElementById('startTime').value,
      endTime: document.getElementById('endTime').value,
      notes: document.getElementById('notes').value.trim(),
      letterFile: fileInput.files[0]?.name || '',
      status: 'Pending'
    };

    // Validasi wajib
    if (!formData.eventName || !formData.roomType || !borrowDate || !duration ||
        !formData.startTime || !formData.endTime || !fileInput.files[0]) {
      addFormError.textContent = 'Semua kolom wajib diisi kecuali Catatan.';
      return;
    }

    // Validasi jam
    if (formData.startTime >= formData.endTime) {
      addFormError.textContent = 'Jam selesai harus lebih besar dari jam mulai.';
      return;
    }

    // Simpan ke global mock array
    if (typeof app !== 'undefined' && app.mockBookings) {
      app.mockBookings.push(formData);
      // Panggil fungsi untuk menyimpan bookings ke localStorage
      app.saveBookings();
    } else {
      console.error('[peminjaman.html] app.mockBookings not found. Booking not saved.');
    }

    // Reset form
    addBookingForm.reset();
    document.getElementById('borrowDate').value = today;
    fileInfo.textContent = '';


    app.dialog.alert('Peminjaman ruangan berhasil ditambahkan!', 'Sukses', () => {
      // Navigate back to calendar
      if (app.views && app.views.main && app.views.main.router) {
        app.views.main.router.navigate('/calendar/', { reloadCurrent: true });
      } else {
        window.location.href = 'calendar.html';
      }
    });
  });

  // Update duration info when form loads
  window.updateDurationInfo();
</script>
</div>
